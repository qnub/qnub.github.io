<!DOCTYPE html>
<html class="window" lang="ru_ru" prefix="ya: https://webmaster.yandex.ru/vocabularies/" prefix="og: http://ogp.me/ns# website: http://ogp.me/ns/website# article: http://ogp.me/ns/article#" >
    <head>
              <meta charset="utf-8">
            <title>qnub's blog &middot; Автообновление сертификатов Let’s Encrypt для Nginx</title>
            <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
            <link href='http://fonts.googleapis.com/css?family=Noto+Sans:400,700,400italic,700italic|Noto+Serif:400,700,400italic,700italic|PT+Mono&subset=latin,cyrillic' rel='stylesheet' type='text/css'>
            <link rel="stylesheet" href="http://qnub.me/theme/css/main.css"/>
            <link rel="stylesheet" href="http://qnub.me/theme/css/pygment.css"/>
            <link rel="shortcut icon" href="http://qnub.me/favicon.ico" />
            <link rel='icon' type='image/x-icon' href='http://qnub.me/favicon.ico'/>
            <link rel="apple-touch-icon-precomposed" href="http://qnub.me/favicon.png">


                <link href="http://qnub.me/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="qnub's blog полный RSS Feed" />
                <link href="http://qnub.me/feeds/it.rss.xml" type="application/rss+xml" rel="alternate" title="qnub's blog RSS Feed раздела &quot;IT&quot;" />
            <meta property="og:site_name" content="qnub's blog" />
            <meta property="og:locale" content="ru_ru" />
        <meta property="og:type" content="article" />
        <meta property="article:author" content="https://www.facebook.com/pages/gikme/137607762942824" />
            <meta property="article:tag" content="ssl" />
            <meta property="article:tag" content="https" />
            <meta property="article:tag" content="letsencrypt" />
            <meta property="article:tag" content="nginx" />


  <link href='http://qnub.me/2015/12/2015-12-05-letsencrypt-nginx-autorenew.html' rel='canonical'/>

    <meta name="description" contents="Let’s Encrypt перешёл в стадию публичной беты, а значит каждый может заполучить себе халявные SSL сертификаты для веба. Одно но — пока они очень короткоиграющие (3 месяца) потому рекомендуется замутить ..." />
    <meta property="og:description" content="Let’s Encrypt перешёл в стадию публичной беты, а значит каждый может заполучить себе халявные SSL сертификаты для веба. Одно но — пока они очень короткоиграющие (3 месяца) потому рекомендуется замутить ..." />

    <meta name="tags" contents="ssl" />
    <meta name="tags" contents="https" />
    <meta name="tags" contents="letsencrypt" />
    <meta name="tags" contents="nginx" />
    <meta property="og:title" content="Автообновление сертификатов Let’s Encrypt для Nginx" />
      <meta property="og:image" content="http://qnub.me/images/it/letsencrypt.png" />
  <meta property="og:url" content="http://qnub.me/2015/12/2015-12-05-letsencrypt-nginx-autorenew.html" />
    </head>
    <body class="page">

        <header class="header">
            <h1 class="header__logo"><a href="http://qnub.me" class="header__logo-link">qnub</a></h1>
            <nav class="header__menu">
                        <a
                            href="http://qnub.me/category/blog.html"
                            class="header__menu-item ">Блог</a>
                        <a
                            href="http://qnub.me/category/game.html"
                            class="header__menu-item ">Игры</a>
                        <a
                            href="http://qnub.me/category/it.html"
                            class="header__menu-item  header__menu-item_active ">It</a>
                <a
                    href="http://qnub.me/archives.html"
                    class="header__menu-item ">Архив</a>
                        <a
                            href="http://qnub.me/pages/about-me.html"
                            class="header__menu-item ">Обо&nbsp;мне</a>
            </nav>
            <div class="header__search">
                <div class="ya-site-form ya-site-form_inited_no" onclick="return {'action':'http://yandex.ru/sitesearch','arrow':false,'bg':'transparent','fontsize':12,'fg':'#000000','language':'ru','logo':'rb','publicname':'Поиск по qnubs blog','suggest':true,'target':'_blank','tld':'ru','type':2,'usebigdictionary':true,'searchid':2200876,'webopt':false,'websearch':false,'input_fg':'#000000','input_bg':'#ffffff','input_fontStyle':'normal','input_fontWeight':'normal','input_placeholder':'Поиск','input_placeholderColor':'#000000','input_borderColor':'#cccbc9'}"><form action="http://yandex.ru/sitesearch" method="get" target="_blank"><input type="hidden" name="searchid" value="2200876"/><input type="hidden" name="l10n" value="ru"/><input type="hidden" name="reqenc" value=""/><input type="search" name="text" value=""/><input type="submit" value="Найти"/></form></div><style type="text/css">.ya-page_js_yes .ya-site-form_inited_no { display: none; }</style><script type="text/javascript">(function(w,d,c){var s=d.createElement('script'),h=d.getElementsByTagName('script')[0],e=d.documentElement;if((' '+e.className+' ').indexOf(' ya-page_js_yes ')===-1){e.className+=' ya-page_js_yes';}s.type='text/javascript';s.async=true;s.charset='utf-8';s.src=(d.location.protocol==='https:'?'https:':'http:')+'//site.yandex.net/v2.0/js/all.js';h.parentNode.insertBefore(s,h);(w[c]||(w[c]=[])).push(function(){Ya.Site.Form.init()})})(window,document,'yandex_site_callbacks');</script>
            </div>
        </header>

        <div class="container cf">
            <main class="content"><article class="article">
	<header class="article__header">
<h1 class="article__title">
	            <a  class="article__link" href="http://qnub.me/2015/12/2015-12-05-letsencrypt-nginx-autorenew.html" rel="bookmark" title="Permanent Link to &quot;Автообновление сертификатов Let&#8217;s Encrypt для&nbsp;Nginx&quot;">Автообновление сертификатов Let&#8217;s Encrypt для&nbsp;Nginx</a>
	        </h1>

		<time class="article__date">05 дек</time>
	</header>
	<section class="article__content cf">
<div class="article__image-wrapper">
		        <img class="article__image" src="http://qnub.me/images/it/letsencrypt.png" alt="Автообновление сертификатов Let&#8217;s Encrypt для&nbsp;Nginx"/>
		    </div>
<p><a href="https://letsencrypt.org/">Let&#8217;s Encrypt</a> перешёл в стадию публичной беты, а значит каждый может заполучить себе халявные <span class="caps">SSL</span> сертификаты для веба. Одно но — пока они очень короткоиграющие (3 месяца) потому рекомендуется замутить себе их автообновление раз в 2&nbsp;месяца.</p>
<p>В один сертификат можно вписать 2 домена. На домен вторго уровня можно получить сертификаты только на 2 домена. Другими словами на каждый домен второго уровня можно сделать халявное шифрование для него самого и одного поддомена или для 2х поддоменов, но не для него самого… Про большую вложенность не знаю, как и про <em>«wildcard»</em> домены. Надеюсь будут&nbsp;позже.</p>
<p>Для начала нужно клонировать репозиторий с утилитой <code>letsencrypt</code>:</p>
<div class="highlight"><pre>git clone https://github.com/letsencrypt/letsencrypt
</pre></div>


<p>Вот вам работающий (на данный момент) скрипт для автообновления сертификатов <a href="https://gist.github.com/qnub/ce475a5007db1d9b04d8">https://gist.github.com/qnub/ce475a5007db1d9b04d8</a>.</p>
<p>В скрипте надо&nbsp;прописать:</p>
<div class="highlight"><pre>EMAIL=user@example.org  # ваш емайл для связи
LETSENCRYPT=/root/letsencrypt  # путь к клонированному репозиторию letsencrypt
MAIN_DOMAIN=example.com  # освноной домен сертификата
SECOND_DOMAIN=example.org  # дополнительный домен сертификата
</pre></div>


<p>Скрипт забиваете в крон от рута на запуск раз в 2 месяца (старт 03:02 1го числа каждого второго&nbsp;месяца):</p>
<div class="highlight"><pre>02 03 01 */2 * /&lt;path_to&gt;/renew-letsencrypt.sh
</pre></div>


<p>Для работы утилиты требуется 80 порт, так что скрипт остановит <code>nginx</code> обновит сертификаты и запустит его снова (ждём плагин для nginx который позволит не отключать сервер для&nbsp;обновления).</p>
<p>Остаётся в настройках домена <code>nginx</code> прописать что-то&nbsp;вроде:</p>
<div class="highlight"><pre><span class="nt">listen</span> <span class="cp">[</span><span class="p">::</span><span class="cp">]</span><span class="nd">:443</span> <span class="nt">ssl</span> <span class="nt">spdy</span><span class="o">;</span>
<span class="nt">listen</span> <span class="nt">443</span> <span class="nt">ssl</span> <span class="nt">spdy</span><span class="o">;</span> <span class="err">#</span> <span class="nt">we</span> <span class="nt">enable</span> <span class="nt">SPDY</span> <span class="nt">here</span>

<span class="nt">ssl</span> <span class="nt">on</span><span class="o">;</span>

<span class="nt">ssl_certificate</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">letsencrypt</span><span class="o">/</span><span class="nt">live</span><span class="o">/&lt;</span><span class="nt">full_domain_name</span><span class="o">&gt;/</span><span class="nt">cert</span><span class="nc">.pem</span><span class="o">;</span>
<span class="nt">ssl_certificate_key</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">letsencrypt</span><span class="o">/</span><span class="nt">live</span><span class="o">/&lt;</span><span class="nt">full_domain_name</span><span class="o">&gt;/</span><span class="nt">privkey</span><span class="nc">.pem</span><span class="o">;</span>
<span class="nt">ssl_trusted_certificate</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">letsencrypt</span><span class="o">/</span><span class="nt">live</span><span class="o">/&lt;</span><span class="nt">full_domain_name</span><span class="o">&gt;/</span><span class="nt">chain</span><span class="nc">.pem</span><span class="o">;</span>

<span class="nt">ssl_stapling</span> <span class="nt">on</span><span class="o">;</span>
<span class="nt">ssl_stapling_verify</span> <span class="nt">on</span><span class="o">;</span>  
<span class="nt">ssl_session_timeout</span> <span class="nt">5m</span><span class="o">;</span>
<span class="nt">ssl_session_cache</span> <span class="nt">shared</span><span class="nd">:SSL:10m</span><span class="o">;</span>

<span class="nt">ssl_protocols</span> <span class="nt">TLSv1</span> <span class="nt">TLSv1</span><span class="nc">.1</span> <span class="nt">TLSv1</span><span class="nc">.2</span><span class="o">;</span>
<span class="nt">ssl_prefer_server_ciphers</span> <span class="nt">on</span><span class="o">;</span>
<span class="nt">ssl_ciphers</span> <span class="s1">&#39;ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK&#39;</span><span class="o">;</span>

<span class="nt">add_header</span> <span class="nt">Strict-Transport-Security</span> <span class="s2">&quot;max-age=63072000;&quot;</span><span class="o">;</span>
</pre></div>


<p>Не забывая заменить в путях <code>&lt;full_domain_name&gt;</code> на имя домена использованного в перменной <code>$MAIN_DOMAIN</code> скрипта&nbsp;автообновления.</p>
<p>Ну и можно сделать редирект с <code>http</code> на <code>https</code>:</p>
<div class="highlight"><pre><span class="nt">server</span> <span class="p">{</span>
    <span class="n">server_name</span> <span class="o">&lt;</span><span class="n">domain_name</span><span class="o">&gt;</span><span class="p">;</span>

    <span class="n">location</span> <span class="o">/</span> <span class="err">{</span>
        <span class="n">rewrite</span>     <span class="o">^</span> <span class="n">https</span><span class="o">://</span><span class="err">$</span><span class="n">server_name</span><span class="err">$</span><span class="n">request_uri</span><span class="o">?</span> <span class="n">permanent</span><span class="p">;</span>
    <span class="p">}</span>
<span class="err">}</span>
</pre></div>


<p><code>&lt;domain_name&gt;</code> — имя домена для редиректа. Собственно конфиги (и редиректы) <code>nginx</code> надо не забыть обновить во всех файлах (если ваши домены в разных файлах). Если у вас нет не зашифрованных серверов — имеет смысл указать редирект на дефолтном&nbsp;сервере…</p>
<p>В данный момент этот скрипт и сертификаты я уже спользую в своих сайтах, в том числе <a href="https://www.registr.xyz">https://www.registr.xyz</a>.</p>
</section>
	<footer class="article__footer">
		<div class="article__meta">опубликовано 18:00&nbsp;&middot;&nbsp;IT            <script type="text/javascript" src="//yastatic.net/share/share.js" charset="utf-8"></script><span class="yashare-auto-init" data-yashareL10n="ru" data-yashareType="small" data-yashareQuickServices="vkontakte,facebook,twitter,gplus,pinterest,odnoklassniki,moimir,surfingbird,evernote" data-yashareTheme="counter" data-yashareImage="http://qnub.me/images/it/letsencrypt.png"></span>
</div><ul class="article__tags"><li class="article__tags-item">
						<a href="http://qnub.me/tag/ssl.html" class="article__tags-link link">ssl</a>
					</li><li class="article__tags-item">
						<a href="http://qnub.me/tag/https.html" class="article__tags-link link">https</a>
					</li><li class="article__tags-item">
						<a href="http://qnub.me/tag/letsencrypt.html" class="article__tags-link link">letsencrypt</a>
					</li><li class="article__tags-item">
						<a href="http://qnub.me/tag/nginx.html" class="article__tags-link link">nginx</a>
					</li>	        </ul>	</footer>
</article>
  <div class="comments" id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = 'qnub';
    var disqus_identifier = '2015/12/2015-12-05-letsencrypt-nginx-autorenew.html';
    var disqus_url = 'http://qnub.me/2015/12/2015-12-05-letsencrypt-nginx-autorenew.html';
    (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//qnub.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the comments.</noscript>
            </main>

            <aside class="sidebar">
<div class="sidebar__item">
    <h4 class="sidebar__title">Проекты</h4>
    <ul class="sidebar__subscribe">
        <li class="sidebar__subscribe-item">
            <a href="http://gik.me" class="sidebar__subscribe-link sidebar__subscribe-link_gikme link" target="_blank">gik.me подкаст</a>
        </li>
        <li class="sidebar__subscribe-item">
            <a href="https://www.registr.xyz" class="sidebar__subscribe-link sidebar__subscribe-link_registr link" target="_blank">REGISTR</a>
        </li>
    </ul>
</div>
<div class="sidebar__item">
    <h4 class="sidebar__title">Контакты</h4>
    <ul class="sidebar__socials">
        <li class="sidebar__socials-item">
            <a href="https://github.com/qnub" class="sidebar__socials-link sidebar__socials-link_gh" target="_blank">GitHub</a>
        </li>
        <li class="sidebar__socials-item">
            <a href="https://ru.linkedin.com/in/vadlop" class="sidebar__socials-link sidebar__socials-link_in" target="_blank">LinkedIn</a>
        </li>
        <li class="sidebar__socials-item">
            <a href="https://vk.com/qnub_ru" class="sidebar__socials-link sidebar__socials-link_vk" target="_blank">VKontakte</a>
        </li>
        <li class="sidebar__socials-item">
            <a href="https://plus.google.com/+VadimLopatyuk" class="sidebar__socials-link sidebar__socials-link_gp" target="_blank">Google+</a>
        </li>
        <li class="sidebar__socials-item">
            <a href="https://twitter.com/qnub" class="sidebar__socials-link sidebar__socials-link_tw" target="_blank">twitter</a>
        </li>
        <li class="sidebar__socials-item">
            <a href="https://telegram.me/qnub_me" class="sidebar__socials-link sidebar__socials-link_tg" target="_blank">telegram</a>
        </li>
        <li class="sidebar__socials-item">
            <a href="https://www.facebook.com/qnub.ru" class="sidebar__socials-link sidebar__socials-link_fb" target="_blank">facebook</a>
        </li>
        <li class="sidebar__socials-item">
            <a href="http://instagram.com/qnub" class="sidebar__socials-link sidebar__socials-link_ig" target="_blank">Instagram</a>
        </li>
        <li class="sidebar__socials-item">
            <a href="http://www.twitch.tv/qnub_ru" class="sidebar__socials-link sidebar__socials-link_twch" target="_blank">twitch</a>
        </li>
        <li class="sidebar__socials-item">
            <a href="https://www.youtube.com/channel/UCoiQsFUonNG_exxkg382V8A" class="sidebar__socials-link sidebar__socials-link_yt" target="_blank">YouTube</a>
        </li>
    </ul>
</div>
<div class="sidebar__item">
    <ul class="article__tags">
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/1886.html" class="article__tags-link link">1886</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/angular.html" class="article__tags-link link">angular</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/cyberpunk.html" class="article__tags-link link">cyberpunk</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/emoji.html" class="article__tags-link link">emoji</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/fahrenheit.html" class="article__tags-link link">fahrenheit</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/github.html" class="article__tags-link link">github</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/ground-zeroes.html" class="article__tags-link link">ground zeroes</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/https.html" class="article__tags-link link">https</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/keyboard.html" class="article__tags-link link">keyboard</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/letsencrypt.html" class="article__tags-link link">letsencrypt</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/metal-gear-solid.html" class="article__tags-link link">metal gear solid</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/meteor.html" class="article__tags-link link">meteor</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/nginx.html" class="article__tags-link link">nginx</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/onboard.html" class="article__tags-link link">onboard</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/order.html" class="article__tags-link link">order</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/pelican.html" class="article__tags-link link">pelican</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/ps4.html" class="article__tags-link link">ps4</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/react.html" class="article__tags-link link">react</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/ssl.html" class="article__tags-link link">ssl</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/static.html" class="article__tags-link link">static</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/ubuntu.html" class="article__tags-link link">ubuntu</a>
        </li>
        <li class="article__tags-item">
            <a href="http://qnub.me/tag/watch-dogs.html" class="article__tags-link link">watch dogs</a>
        </li>
    </ul>
</div>
<div class="sidebar__item">
    <h4 class="sidebar__title">Комментарии</h4>
    <script type="text/javascript" src="http://qnub.disqus.com/recent_comments_widget.js"></script>
</div>
<div class="sidebar__item">
<a class="twitter-timeline" href="https://twitter.com/qnub" data-widget-id="569226580497797120" target="_blank">Твиты от @qnub</a>
<script type="text/javascript">!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</div>
<div class="sidebar__item">
    <a href="http://orphus.ru" id="orphus" target="_blank"><img alt="Система Orphus" src="http://qnub.me/theme/img/orphus.gif" border="0" width="220" height="80" /></a>
</div>            </aside>
        </div>

        <footer class="footer">
        </footer>
            <script type="text/javascript">
                var disqus_shortname = 'qnub';
                (function () {
                    var s = document.createElement('script'); s.async = true;
                    s.type = 'text/javascript';
                    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
                    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
                }());
            </script>
        <script type="text/javascript" src="http://qnub.me/theme/js/jquery.min.js"></script>
        <script type="text/javascript" src="//vk.com/js/api/openapi.js?116"></script>
        <script type="text/javascript" src="http://qnub.me/theme/js/jquery.fluidbox.min.js"></script>
        <script type="text/javascript" src="http://qnub.me/theme/js/main.js"></script>
        <script type="text/javascript" src="http://qnub.me/theme/js/orphus.js"></script>
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-59564142-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>
    <script type="text/javascript">(function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w['yaCounter28356266'] = new Ya.Metrika({ id:28356266, webvisor:true, trackHash:true, ut:"noindex" }); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script>
    </body>
</html>